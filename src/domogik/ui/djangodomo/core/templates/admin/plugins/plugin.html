{% extends "layout_admin.html" %}
{% comment %}
# Copyright 2008 Domogik project

# This file is part of Domogik.
# Domogik is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# Domogik is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with Domogik.  If not, see <http://www.gnu.org/licenses/>.

# Author : Cédric Trévisan <cedric@domogik.org>
{% endcomment %}


{% load i18n %}
{% block js_script %}
$(function(){
    // Accordion
	$("#nav2").accordion({ autoHeight: false, header: ".subnav2", active:2});
    
    {% ifequal plugin.status "ON" %}
        $("#buttonstatus").click(function() {
            $("#buttonstatus").attr('className', 'button icon16-action-loading');
            $.getREST(['plugin', 'stop', '{{ plugin.name }}'],
                function(data) {
                    var status = (data.status).toLowerCase();
                    if (status == 'ok') {
                        $.reloadPage({'status': 'ok', 'msg': '{% trans "Success" %} : {% trans "Plugin" %}\'{{ plugin.name }}\' {% trans "successfully stopped" %}'});
                    } else {
                        $.reloadPage({'status': 'error', 'msg': '{% trans "Error" %} : {% trans "Plugin not stopped" %} (' + data.description + ')'});
                    }
                }
            );
        });
    {% else %}
        $("#buttonstatus").click(function() {
            $("#buttonstatus").attr('className', 'button icon16-action-loading');
            $.getREST(['plugin', 'start', '{{ plugin.name }}'],
                function(data) {
                    var status = (data.status).toLowerCase();
                    if (status == 'ok') {
                        $.reloadPage({'status': 'ok', 'msg': '{% trans "Success" %} : {% trans "Plugin" %}\'{{ plugin.name }}\' {% trans "successfully started" %}'});
                    } else {
                        $.reloadPage({'status': 'error', 'msg': '{% trans "Error" %} : {% trans "Plugin not started" %} (' + data.description + ')'});
                    }
                }
            );
        });
    {% endifequal %}
    
    function resetKey(key, value) {
        $("#value_" + key).val(value);
        $("#value_" + key).attr('class', 'medium icon16-status-warning');
    }
    
    function deleteConfig(name) {
        $.getREST(['plugin', 'config', 'del', name],
            function(data) {
                var status = (data.status).toLowerCase();
                if (status == 'ok') {
                    $.reloadPage({'status': 'ok', 'msg': '{% trans "Success" %} : {% trans "Configuration deleted" %}'});
                } else {
                    /* Error */
                    display_message(data.status, data.description);
                }
            }
        );
    }
    
    function saveConfig(name, configuration) {
        var itemSaved = 0;
        $.each(configuration, function(index, item) {
            var value = null;
            if (item.key == 'startup-plugin') {
                value = ($('#value_' + item.key + ':checked').length > 0)? 'True':'False';
            } else {
                value = $('#value_' + item.key).val();
            
            }
            $.getREST(['plugin', 'config', 'set', 'name', name, 'key', item.key, 'value', value],
                function(data) {
                    var status = (data.status).toLowerCase();
                    if (status == 'ok') {
                        $('#value_' + item.key).attr('class', 'medium icon16-status-true');
                        itemSaved++;
                        if (itemSaved == configuration.length) { // All saved without error
                            display_message('OK', "Configuration saved successfully");
                        }
                    } else {
                        // Error
                        $('#value_' + item.key).attr('class', 'medium icon16-status-false');
                        display_message(data.status, data.description);
                    }
                }
            );
        });
    }

    /* Get the list of configuration items */
    $.getREST(['plugin', 'detail', '{{ plugin.name }}'],
        function(data) {
            var status = (data.status).toLowerCase();
            if (status == 'ok') {
                var num_items = data.plugin[0].configuration.length;
                $.each(data.plugin[0].configuration, function(index, item) {
                    var ikey = item.key;
                    var idescription = item.description;
                    var idefault = item['default'];
                    $.getREST(['plugin', 'config', 'list', 'by-name' , '{{ plugin.name }}' , 'by-key', ikey],
                        function(data) {
                            var status = (data.status).toLowerCase();
                            if (status == 'ok') {
                                var tr = $("<tr></tr>");
                                tr.append("<td>" +  ikey + "</td><td><label for='value_" + ikey + "'>" +  idescription + "</label></td>");
                                if (ikey == 'startup-plugin') {
                                    $(tr).append("<td><input type='checkbox' name='value_" + ikey + "' id='value_" + ikey + "' /></td><td></td>");
                                    if (data.config.length > 0) { // If already configured
                                        if (data.config[0].value  == "True") {
                                            $("#value_" + ikey, tr).attr('checked', true);
                                        }
                                    }
                                } else {
                                    if (data.config.length > 0) { // If already configured
                                        $(tr).append("<td><input type='text' name='value_" + ikey + "' id='value_" + ikey + "' class='medium' value='" +  data.config[0].value + "' /></td>");                                                                            
                                    } else { // If not configured
                                        $(tr).append("<td><input type='text' name='value_" + ikey + "' id='value_" + ikey + "' class='medium icon16-status-warning' title='Default value' value='" +  idefault + "' /></td>");
                                    }
                                    $(tr).append("<td><ul class='actions'><li><button id='reset" + ikey + "' class='icon16-action-reset buttonicon' title='{% trans "Reset" %} " + ikey + "'><span class='offscreen'>{% trans "Reset" %} " + ikey + "</span></button></li></ul></td>");                                    
                                }
                                $("#configuration_items").append(tr);
                                $("#reset" + ikey).click(function(event) {
                                    resetKey(ikey, idefault);
                                    event.stopPropagation();
                                });
                            } else {
                                /* Error retreving plugin item config */
                                display_message(data.status, data.description);
                            }
                        }
                    );
                });
                
                $.getREST(['plugin', 'config', 'list' ,'by-name', '{{ plugin.name }}'],
                    function(data) {
                        var status = (data.status).toLowerCase();
                        if (status == 'ok') {
                            var never_configured = num_items - data.config.length;
                            if (never_configured > 0) {
                                display_message('WARNING', never_configured + " item(s) not configured yet");                                            
                            }
                        } else {
                            /* Error retreving plugin config */
                            display_message(data.status, data.description);
                        }
                    });
                $("#configuration").append("<p><button id='configurationsubmit' class='button icon16-action-save'>{% trans "Save" %}</button></p>");
                $("#configurationsubmit").click(function(event) {
                    saveConfig('{{ plugin.name }}', data.plugin[0].configuration);
                    event.stopPropagation();
                });
            } else {
                /* Error to get plugin default config */
                display_message(data.status, data.description);
            }
        }
    );

    $("#configurationdelete").click(function(event) {
        deleteConfig('{{ plugin.name }}');
    });
});
{% endblock %}
{% block css %}
    <link href="/design/skins/{{ request.session.user.skin_used|default:'default' }}/css/ui-tables.css" rel="stylesheet" type="text/css" />
{% endblock %}
{% block js_include %}
{% endblock %}
{% block title %}{% trans page_title %}{% endblock %}

{% block banner %}
    <h1 class="ident icon64-plugin-{{ plugin.name }}">
        <span class="title">{% trans "Plugin" %} '{{ plugin.name }}'</span>
        <br />
        <span class="subtitle">{{ plugin.description }}</span>
    </h1>
    {% ifnotequal status "" %}
    <div id='messages' class='{{status}}'>{{msg}}</div>
    {% endifnotequal %}
{% endblock %}

{% block right %}
    <section class="subsection">
        <h2>{% trans "Basic Control" %}</h2>
        <ul>
            <li>{% trans "Version" %}: {{ plugin.version }}</li>
            <li>{% trans "Documentation" %}: <a href='{{ plugin.documentation }}'>Wiki</a></li>
            <li>{% trans "Host" %}: {{ plugin.host }}</li>
            {% ifnotequal plugin.name "rest" %}
                <li>{% trans "Technology" %}: {{ plugin.technology }}</li>
                <li>
                {% ifequal plugin.status "ON" %}
                    <div class='icon16-text-right icon16-status-active'>{% trans "Status" %}:<span class='offscreen'>{% trans "Running" %}</span></div>
                {% else %}
                    <div class='icon16-text-right icon16-status-inactive'>{% trans "Status" %}:<span class='offscreen'>{% trans "Stopped" %}</span></div>                        
                {% endifequal %}
                </li>
            {% endifnotequal %}
        </ul>
        {% ifnotequal plugin.name "rest" %}
            {% ifequal plugin.status "ON" %}
                <button id='buttonstatus' class='button icon16-status-inactive'>{% trans "Stop" %}</button>
            {% else %}
                <button id='buttonstatus' class='button icon16-status-active'>{% trans "Start" %}</button>
            {% endifequal %}
        {% endifnotequal %}
    </section>
    <section class="subsection">
        <h2>{% trans "Configuration" %}</h2>
        <div id='configuration'>
            <p><button id='configurationdelete' class='button icon16-action-del'>{% trans 'Delete configuration' %}</button></p>
            <table id='configuration_items'>
                <tr><th scope='col'>{% trans "Key" %}</th><th scope='col'>{% trans "Description" %}</th><th scope='col'>{% trans "value" %}</th><th>{% trans "Actions" %}</th></tr>
            </table>
        </div>
    </section>
{% endblock %}
