{% extends "base/base.html" %}

{% block content %}
{% include "client_menu.html" %}
<div class="container">
    <h2>{% trans %}Known Devices{% endtrans %}</h2>
    {% if devices|length > 0 %}
      <table class="table table-striped table-hover table-condensed">
        <thead>
          <tr>
            <th>{% trans %}Name{% endtrans %}</th>
            <th>{% trans %}Device Type{% endtrans %}</th>
            <th>{% trans %}Actions{% endtrans %}</th>
          </tr>
        </thead>
        <tbody>
          {% for data in devices %}
            <tr class="accordion-toggle">
              <td>{{ data.name }}</td>
              <td>{{ data.device_type_id }}</td>
              <td>
                  <a class="btn btn-primary" data-toggle="collapse" data-target=".detail-{{ data.id }}" href="#"><span class='glyphicon glyphicon-chevron-down' aria-hidden='true'></span> Details</a>  
                  <a class="btn btn-default" href="/client/{{ clientid }}/dmg_devices/edit/{{ data.id }}"><span class='glyphicon glyphicon-pencil' aria-hidden='true'></span> {% trans %}Edit{% endtrans %}</a> 
                  <a class="btn btn-default" data-toggle="confirmation" data-placement="bottom" data-href="/client/{{ clientid }}/dmg_devices/delete/{{ data.id }}"><span class='glyphicon glyphicon-trash' aria-hidden='true'></span> {% trans %}Delete{% endtrans %}</a>
              </td>
            </tr>
            <tr>
              <td colspan="6" class="hiddenRow"> 
                <div class="accordian-body collapse detail-{{ data.id }}">
                  <div class="panel panel-default">
                    <div class="panel-heading">
                      <h3 class="panel-title">{% trans %}Informations{% endtrans %}</h3>
                    </div>
                    <div class="panel-body">
                      <ul>
                        <!-- <div>{{ data }}</div> -->
                        <li><strong>id</strong> : {{ data.id }}</li>
                        <li><strong>{% trans %}Device type id{% endtrans %}</strong> : {{ data.device_type_id }}</li>
                        <li><strong>{% trans %}Reference{% endtrans %}</strong> : {{ data.reference }}</li>
                        <li><strong>{% trans %}Description{% endtrans %}</strong> : {{ data.description }}</li>
                      </ul>
                    </div>
                  </div>

                  {% if data.parameters|length > 0 %}
                    <div class="panel panel-default">
                      <div class="panel-heading">
                        <h3 class="panel-title">{% trans %}Global parameters{% endtrans %}</h3>
                      </div>
                      <div class="panel-body">
                        <table class="table table-bordered">
                          <thead>
                            <tr>
                              <th>{% trans %}ID{% endtrans %}</th>
                              <th>{% trans %}Name{% endtrans %}</th>
                              <th>{% trans %}Value{% endtrans %}</th>
                              <th>{% trans %}Type{% endtrans %}</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for tmp in data.parameters %}
                              <tr>
                                <td>{{ data.parameters[tmp].id }}</td>
                                <td>{{ data.parameters[tmp].key }}</td>
                                <td>{{ data.parameters[tmp].value }}</td>
                                <td>{{ data.parameters[tmp].type }}</td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  {% endif %}

                  {% if data.sensors|length > 0 %}
                    <div class="panel panel-default">
                      <div class="panel-heading">
                        <h3 class="panel-title">{% trans %}Sensors{% endtrans %}</h3>
                      </div>
                      <div class="panel-body">
                        {% for name, sen in data.sensors|sortid %}
                          <div>
                            <h4>{{ sen.name }} <small>(id = {{ sen.id }})</small>
                              <a class="btn btn-default" href="/client/{{ clientid }}/sensors/edit/{{ sen.id }}"><span class='glyphicon glyphicon-pencil' aria-hidden='true'></span> {% trans %}Configure{% endtrans %}</a>
                            </h4>
                            <table class="table table-bordered">
                              <tbody>
                                <tr>
                                  <th>{% trans %}Data Type{% endtrans %}</th>
                                  <td>{{ sen.data_type }}</td>
                                <tr>
                                </tr>
                                  <th>{% trans %}Last value{% endtrans %}</th>
                                  <td>{% if sen.last_value %}{{ sen.last_value }}{% if datatypes[sen.data_type].unit %}&nbsp;{{ datatypes[sen.data_type].unit }}{% endif %}{% else %}&nbsp;{% endif %}</td>
                                <tr>
                                </tr>
                                  <th>{% trans %}Last received{% endtrans %}</th>
                                  <td>{% if sen.last_value %}{{ sen.last_received|datetime }}{% endif %}</td>
                                <tr>
                                </tr>
                                  <th>{% trans %}Rest URL{% endtrans %}</th>
                                  {% set sensor_url = rest_url + "/sensorhistory/id/" + sen.id|string + "/last/10" %}
                                  <td><a href="{{ sensor_url }}">{{ sensor_url }}</a></td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}

                  {% if data.commands|length > 0 %}
                    <div class="panel panel-default">
                      <div class="panel-heading">
                        <h3 class="panel-title">{% trans %}Commands{% endtrans %}</h3>
                      </div>
                      <div class="panel-body">
                        {% for name, cmd in data.commands|sortid %}
                          <div>
                            <h4>{{ cmd.name }} <small>(id = {{ cmd.id }})</h4>
                            {% for param in cmd.parameters %}
                              <table class="table table-bordered">
                                <tbody>
                                  <tr>
                                    <th>{% trans %}Command Key{% endtrans %}</th>
                                    <td>{{ param.key }}</td>
                                  </tr>
                                  <tr>
                                    <th>{% trans %}Data Type{% endtrans %}</th>
                                    <td>{{ param.data_type }} : {{ datatypes[param.data_type] }}</td>
                                  </tr>
                                  <tr>
                                    <th>{% trans %}Example REST url{% endtrans %}</th>
                                    <td>
                                      {% trans %}Urls{% endtrans %}:
                                      {% if param.data_type == "DT_Bool" or datatypes[param.data_type]['parent'] == "DT_Bool" %}
                                        {% set url_sample = rest_url + "/cmd/id/" + cmd.id|string + "?" + param.key + "=" %}
                                        {% set url_0 = url_sample + "0" %}
                                        {% set url_1 = url_sample + "1" %}
                                        <ul>
                                          <li><strong>{{ datatypes[param.data_type]['labels']['0'] }}</strong> : {{ url_0 }}</li>
                                          <li><strong>{{ datatypes[param.data_type]['labels']['1'] }}</strong> : {{ url_1 }}</li>
                                        </ul>
                                        <div>
                                          <p>Test it :</p>
                                          <a class="btn btn-primary" href="{{ url_0 }}">{{ datatypes[param.data_type]['labels']['0'] }} (0)</a> 
                                          <a class="btn btn-primary" href="{{ url_1 }}">{{ datatypes[param.data_type]['labels']['1'] }} (1)</a> 
                                        </div>
                                      {% else %}
                                        {{ rest_url }}/cmd/id/{{cmd.id}}?{{param.key}}=&lt;key&gt;
                                      {% endif %}
                                    </td>
                                  </tr>
                                </tbody>
                              </table>
                            {% endfor %}
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}

                  {% if data.xpl_stats|length > 0 %}
                    <span class="label label-default">{% trans %}Xplstats{% endtrans %}</span>
                                        <table class="table table-bordered">
                                            {% for name in data.xpl_stats %}
                                                <tr>
                                                    <th>{% trans %}Name{% endtrans %}</th>
                                                    <td>{{ name }}</td>
                                                    <th>{% trans %}Schema{% endtrans %}</th>
                                                    <td>{{ data.xpl_stats[name].schema }}</td>
                                                </tr>
                                                <tr>
                                                    <th>{% trans %}Type{% endtrans %}</th>
                                                    <th>{% trans %}Key{% endtrans %}</th>
                                                    <th colspan="2">{% trans %}Value{% endtrans %} {% trans %}or{% endtrans %} {% trans %}Sensor{% endtrans %}</th>
                                                </tr>
                                                {% for param in data.xpl_stats[name].parameters.static %}
                                                <tr>
                                                                            <td>Static</td>
                                                    <td>{{ param.key }}</td>
                                                    <td colspan="2">{{ param.value }}</td>
                                                </tr>
                                                {% endfor %}
                                                {% for param in data.xpl_stats[name].parameters.dynamic %}
                                                <tr>
                                                                            <td>Dynamic</td>
                                                    <td>{{ param.key }}</td>
                                                    <td colspan="2">{{ param.sensor_name }}</td>
                                                </tr>
                                                {% endfor %}
                                            {% endfor %}
                                        </table>
                {% endif %}
                {% if data.xpl_commands|length > 0 %}
                    <span class="label label-default">{% trans %}Xpl commands{% endtrans %}</span>
                                        <table class="table table-bordered">
                                        {% for name in data.xpl_commands %}
                                                <tr>
                                                    <th>{% trans %}Name{% endtrans %}</th>
                                                    <td>{{ name }}</td>
                                                    <th>{% trans %}Schema{% endtrans %}</th>
                                                    <td>{{ data.xpl_commands[name].schema }}</td>
                                                </tr>
                                                <tr>
                                                    <th colspan="2">{% trans %}Type{% endtrans %}</th>
                                                    <th colspan="2">{% trans %}Value{% endtrans %}</th>
                                                </tr>
                                                {% for param in data.xpl_commands[name].parameters %}
                                                <tr>
                                                    <td colspan="2">{{ param.key }}</td>
                                                    <td colspan="2">{{ param.value }}</td>
                                                </tr>
                                                {% endfor %}
                                        {% endfor %}
                                        </table>
                {% endif %}
                                </div> 
 
                            </td>
                    </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
    <div class="alert alert-warning">{% trans %}No devices found{% endtrans %}</div>
    {% endif %}
</div>
{% endblock %}
